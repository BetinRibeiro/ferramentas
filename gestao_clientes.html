<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestão de Clientes</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/uuid/8.3.2/uuid.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .slide-in {
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from { transform: translateX(100%); }
            to { transform: translateX(0); }
        }
        
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
    </style>
</head>
<body class="bg-gray-100 font-sans">
    <div class="container mx-auto px-4 py-8 max-w-6xl">
        <!-- Header -->
        <header class="mb-8">
            <div class="flex justify-between items-start">
                <div>
                    <h1 class="text-3xl font-bold text-indigo-700">Gestão de Clientes</h1>
                    <p class="text-gray-600">Gerencie seus clientes e transações</p>
                </div>
                <div class="flex space-x-2">
                    <button id="exportBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white py-2 px-4 rounded-md flex items-center transition">
                        <i class="fas fa-file-export mr-2"></i> Exportar
                    </button>
                    <label for="importInput" class="bg-green-600 hover:bg-green-700 text-white py-2 px-4 rounded-md flex items-center transition cursor-pointer">
                        <i class="fas fa-file-import mr-2"></i> Importar
                        <input id="importInput" type="file" accept=".json" class="hidden">
                    </label>
                </div>
            </div>
        </header>
        
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Left Column - Customer List -->
            <div class="lg:col-span-1 bg-white rounded-lg shadow-md overflow-hidden">
                <div class="p-4 bg-indigo-600 text-white">
                    <h2 class="text-xl font-semibold">Lista de Clientes</h2>
                    <div class="relative mt-2">
                        <input type="text" id="searchCustomer" placeholder="Buscar cliente..." 
                               class="w-full px-4 py-2 rounded-md bg-indigo-500 text-white placeholder-indigo-200 focus:outline-none focus:ring-2 focus:ring-indigo-300">
                        <i class="fas fa-search absolute right-3 top-3 text-indigo-200"></i>
                    </div>
                </div>
                
                <div class="p-4">
                    <button id="addCustomerBtn" class="w-full mb-4 bg-green-600 hover:bg-green-700 text-white py-2 px-4 rounded-md flex items-center justify-center transition">
                        <i class="fas fa-plus mr-2"></i> Novo Cliente
                    </button>
                    
                    <div id="customerList" class="space-y-2 max-h-96 overflow-y-auto custom-scrollbar">
                        <!-- Customers will be loaded here -->
                    </div>
                </div>
            </div>
            
            <!-- Right Column - Customer Details and Transactions -->
            <div class="lg:col-span-2 space-y-6">
                <!-- Customer Details Card -->
                <div id="customerDetailsCard" class="bg-white rounded-lg shadow-md p-6 hidden fade-in">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <h2 id="customerName" class="text-2xl font-bold text-gray-800"></h2>
                            <p id="customerContact" class="text-gray-600"></p>
                        </div>
                        <div class="flex space-x-2">
                            <button id="editCustomerBtn" class="text-indigo-600 hover:text-indigo-800">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button id="deleteCustomerBtn" class="text-red-600 hover:text-red-800">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <p class="text-sm text-gray-500">Total Vendas</p>
                            <p id="totalSales" class="text-xl font-semibold text-indigo-600">R$ 0,00</p>
                        </div>
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <p class="text-sm text-gray-500">Total Recebimentos</p>
                            <p id="totalReceipts" class="text-xl font-semibold text-green-600">R$ 0,00</p>
                        </div>
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <p class="text-sm text-gray-500">Saldo</p>
                            <p id="balance" class="text-xl font-semibold">R$ 0,00</p>
                        </div>
                    </div>
                    
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold text-gray-700">Extrato</h3>
                        <div class="flex space-x-2">
                            <button id="addSaleBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white py-1 px-3 rounded-md text-sm flex items-center">
                                <i class="fas fa-shopping-cart mr-1"></i> Venda
                            </button>
                            <button id="addReceiptBtn" class="bg-green-600 hover:bg-green-700 text-white py-1 px-3 rounded-md text-sm flex items-center">
                                <i class="fas fa-money-bill-wave mr-1"></i> Recebimento
                            </button>
                        </div>
                    </div>
                    
                    <div id="transactionsList" class="border rounded-lg divide-y max-h-96 overflow-y-auto custom-scrollbar">
                        <!-- Transactions will be loaded here -->
                        <div class="p-4 text-center text-gray-500">
                            Nenhuma transação registrada
                        </div>
                    </div>
                </div>
                
                <!-- Empty State -->
                <div id="emptyState" class="bg-white rounded-lg shadow-md p-12 text-center fade-in">
                    <i class="fas fa-users text-5xl text-gray-300 mb-4"></i>
                    <h3 class="text-xl font-semibold text-gray-600 mb-2">Nenhum cliente selecionado</h3>
                    <p class="text-gray-500 mb-6">Selecione um cliente da lista para visualizar ou adicionar transações</p>
                    <button id="addFirstCustomerBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white py-2 px-6 rounded-md inline-flex items-center">
                        <i class="fas fa-plus mr-2"></i> Adicionar Primeiro Cliente
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Customer Modal -->
    <div id="customerModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md slide-in">
            <div class="p-6">
                <h3 id="modalTitle" class="text-xl font-semibold mb-4">Adicionar Cliente</h3>
                
                <form id="customerForm">
                    <input type="hidden" id="customerId">
                    <div class="mb-4">
                        <label for="name" class="block text-sm font-medium text-gray-700 mb-1">Nome</label>
                        <input type="text" id="name" required
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    </div>
                    <div class="mb-4">
                        <label for="email" class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                        <input type="email" id="email"
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    </div>
                    <div class="mb-4">
                        <label for="phone" class="block text-sm font-medium text-gray-700 mb-1">Telefone</label>
                        <input type="tel" id="phone" pattern="\([0-9]{2}\) [0-9]{4,5}-[0-9]{4}"
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500"
                               placeholder="(99) 99999-9999">
                    </div>
                    <div class="mb-4">
                        <label for="address" class="block text-sm font-medium text-gray-700 mb-1">Endereço</label>
                        <textarea id="address" rows="2"
                                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500"></textarea>
                    </div>
                    
                    <div class="flex justify-end space-x-3 mt-6">
                        <button type="button" id="cancelCustomerBtn" class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50">Cancelar</button>
                        <button type="submit" id="saveCustomerBtn" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700">Salvar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Transaction Modal -->
    <div id="transactionModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md slide-in">
            <div class="p-6">
                <h3 id="transactionModalTitle" class="text-xl font-semibold mb-4">Nova Venda</h3>
                
                <form id="transactionForm">
                    <input type="hidden" id="transactionId">
                    <input type="hidden" id="transactionCustomerId">
                    <input type="hidden" id="transactionType">
                    
                    <div class="mb-4">
                        <label for="transactionDate" class="block text-sm font-medium text-gray-700 mb-1">Data</label>
                        <input type="date" id="transactionDate" required
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    </div>
                    <div class="mb-4">
                        <label for="transactionDescription" class="block text-sm font-medium text-gray-700 mb-1">Descrição</label>
                        <input type="text" id="transactionDescription" required
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    </div>
                    <div class="mb-4">
                        <label for="transactionAmount" class="block text-sm font-medium text-gray-700 mb-1">Valor (R$)</label>
                        <input type="number" id="transactionAmount" step="0.01" min="0" required
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    </div>
                    
                    <div class="flex justify-end space-x-3 mt-6">
                        <button type="button" id="cancelTransactionBtn" class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50">Cancelar</button>
                        <button type="submit" id="saveTransactionBtn" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700">Salvar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Confirmation Modal -->
    <div id="confirmationModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md slide-in">
            <div class="p-6">
                <div class="flex items-center mb-4">
                    <div class="bg-red-100 p-3 rounded-full mr-3">
                        <i class="fas fa-exclamation-circle text-red-600 text-xl"></i>
                    </div>
                    <h3 id="confirmationTitle" class="text-xl font-semibold">Confirmar Exclusão</h3>
                </div>
                
                <p id="confirmationMessage" class="text-gray-600 mb-6">Tem certeza que deseja excluir este cliente? Todas as transações associadas também serão removidas.</p>
                
                <div class="flex justify-end space-x-3">
                    <button type="button" id="cancelConfirmationBtn" class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50">Cancelar</button>
                    <button type="button" id="confirmActionBtn" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700">Excluir</button>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // Database setup
        let db;
        const DB_NAME = "CustomerManagementDB";
        const DB_VERSION = 1;
        
        // Open or create database
        const request = indexedDB.open(DB_NAME, DB_VERSION);
        
        request.onupgradeneeded = (event) => {
            db = event.target.result;
            
            // Create customers store
            if (!db.objectStoreNames.contains('customers')) {
                const customersStore = db.createObjectStore('customers', { keyPath: 'id', autoIncrement: true });
                customersStore.createIndex('name', 'name', { unique: false });
            }
            
            // Create transactions store
            if (!db.objectStoreNames.contains('transactions')) {
                const transactionsStore = db.createObjectStore('transactions', { keyPath: 'id', autoIncrement: true });
                transactionsStore.createIndex('customerId', 'customerId', { unique: false });
                transactionsStore.createIndex('date', 'date', { unique: false });
            }
        };
        
        request.onsuccess = (event) => {
            db = event.target.result;
            loadCustomers();
        };
        
        request.onerror = (event) => {
            console.error("Database error:", event.target.error);
        };
        
        // DOM elements
        const customerList = document.getElementById('customerList');
        const customerDetailsCard = document.getElementById('customerDetailsCard');
        const emptyState = document.getElementById('emptyState');
        const customerName = document.getElementById('customerName');
        const customerContact = document.getElementById('customerContact');
        const totalSales = document.getElementById('totalSales');
        const totalReceipts = document.getElementById('totalReceipts');
        const balance = document.getElementById('balance');
        const transactionsList = document.getElementById('transactionsList');
        const searchCustomer = document.getElementById('searchCustomer');
        
        // Modal elements
        const customerModal = document.getElementById('customerModal');
        const modalTitle = document.getElementById('modalTitle');
        const customerForm = document.getElementById('customerForm');
        const customerId = document.getElementById('customerId');
        const nameInput = document.getElementById('name');
        const emailInput = document.getElementById('email');
        const phoneInput = document.getElementById('phone');
        const addressInput = document.getElementById('address');
        
        const transactionModal = document.getElementById('transactionModal');
        const transactionModalTitle = document.getElementById('transactionModalTitle');
        const transactionForm = document.getElementById('transactionForm');
        const transactionId = document.getElementById('transactionId');
        const transactionCustomerId = document.getElementById('transactionCustomerId');
        const transactionType = document.getElementById('transactionType');
        const transactionDate = document.getElementById('transactionDate');
        const transactionDescription = document.getElementById('transactionDescription');
        const transactionAmount = document.getElementById('transactionAmount');
        
        const confirmationModal = document.getElementById('confirmationModal');
        const confirmationTitle = document.getElementById('confirmationTitle');
        const confirmationMessage = document.getElementById('confirmationMessage');
        
        // Buttons
        const addCustomerBtn = document.getElementById('addCustomerBtn');
        const addFirstCustomerBtn = document.getElementById('addFirstCustomerBtn');
        const editCustomerBtn = document.getElementById('editCustomerBtn');
        const deleteCustomerBtn = document.getElementById('deleteCustomerBtn');
        const addSaleBtn = document.getElementById('addSaleBtn');
        const addReceiptBtn = document.getElementById('addReceiptBtn');
        const saveCustomerBtn = document.getElementById('saveCustomerBtn');
        const cancelCustomerBtn = document.getElementById('cancelCustomerBtn');
        const saveTransactionBtn = document.getElementById('saveTransactionBtn');
        const cancelTransactionBtn = document.getElementById('cancelTransactionBtn');
        const confirmActionBtn = document.getElementById('confirmActionBtn');
        const cancelConfirmationBtn = document.getElementById('cancelConfirmationBtn');
        
        // Current selected customer
        let currentCustomer = null;
        
        // Event listeners
        document.getElementById('exportBtn').addEventListener('click', exportData);
        document.getElementById('importInput').addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                importData(e.target.files[0]);
                e.target.value = ''; // Reset input
            }
        });
        
        addCustomerBtn.addEventListener('click', () => openCustomerModal('add'));
        addFirstCustomerBtn.addEventListener('click', () => openCustomerModal('add'));
        editCustomerBtn.addEventListener('click', () => {
            if (currentCustomer) {
                openCustomerModal('edit', currentCustomer);
            }
        });
        deleteCustomerBtn.addEventListener('click', () => openConfirmationModal('customer'));
        addSaleBtn.addEventListener('click', () => openTransactionModal('sale'));
        addReceiptBtn.addEventListener('click', () => openTransactionModal('receipt'));
        
        cancelCustomerBtn.addEventListener('click', () => customerModal.classList.add('hidden'));
        cancelTransactionBtn.addEventListener('click', () => transactionModal.classList.add('hidden'));
        cancelConfirmationBtn.addEventListener('click', () => confirmationModal.classList.add('hidden'));
        
        customerForm.addEventListener('submit', saveCustomer);
        transactionForm.addEventListener('submit', saveTransaction);
        confirmActionBtn.addEventListener('click', confirmAction);
        
        searchCustomer.addEventListener('input', () => loadCustomers(searchCustomer.value));
        
        // Functions
        function loadCustomers(searchTerm = '') {
            const transaction = db.transaction('customers', 'readonly');
            const store = transaction.objectStore('customers');
            const index = store.index('name');
            const request = index.getAll();
            
            request.onsuccess = (event) => {
                const customers = event.target.result;
                customerList.innerHTML = '';
                
                if (customers.length === 0) {
                    customerList.innerHTML = `
                        <div class="text-center py-4 text-gray-500">
                            Nenhum cliente cadastrado
                        </div>
                    `;
                    return;
                }
                
                // Filter customers by search term
                const filteredCustomers = searchTerm 
                    ? customers.filter(c => 
                        c.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                        (c.email && c.email.toLowerCase().includes(searchTerm.toLowerCase())) ||
                        (c.phone && c.phone.includes(searchTerm))
                      )
                    : customers;
                
                if (filteredCustomers.length === 0) {
                    customerList.innerHTML = `
                        <div class="text-center py-4 text-gray-500">
                            Nenhum cliente encontrado
                        </div>
                    `;
                    return;
                }
                
                filteredCustomers.forEach(customer => {
                    const customerElement = document.createElement('div');
                    customerElement.className = 'p-3 border rounded-lg cursor-pointer hover:bg-gray-50 transition';
                    customerElement.innerHTML = `
                        <div class="flex justify-between items-center">
                            <div>
                                <h4 class="font-medium text-gray-800">${customer.name}</h4>
                                ${customer.phone ? `<p class="text-sm text-gray-500">${customer.phone}</p>` : ''}
                            </div>
                            <i class="fas fa-chevron-right text-gray-400"></i>
                        </div>
                    `;
                    
                    customerElement.addEventListener('click', () => selectCustomer(customer));
                    customerList.appendChild(customerElement);
                });
            };
            
            request.onerror = (event) => {
                console.error("Error loading customers:", event.target.error);
            };
        }
        
        function selectCustomer(customer) {
            currentCustomer = customer;
            
            // Update customer details
            customerName.textContent = customer.name;
            
            let contactInfo = [];
            if (customer.email) contactInfo.push(customer.email);
            if (customer.phone) contactInfo.push(customer.phone);
            customerContact.textContent = contactInfo.join(' | ');
            
            // Show customer details and hide empty state
            customerDetailsCard.classList.remove('hidden');
            emptyState.classList.add('hidden');
            
            // Load transactions for this customer
            loadTransactions(customer.id);
        }
        
        function loadTransactions(customerId) {
            const transaction = db.transaction('transactions', 'readonly');
            const store = transaction.objectStore('transactions');
            const index = store.index('customerId');
            const request = index.getAll(customerId);
            
            request.onsuccess = (event) => {
                const transactions = event.target.result;
                
                // Calculate totals
                let salesTotal = 0;
                let receiptsTotal = 0;
                
                transactions.forEach(t => {
                    if (t.type === 'sale') {
                        salesTotal += t.amount;
                    } else if (t.type === 'receipt') {
                        receiptsTotal += t.amount;
                    }
                });
                
                const balanceTotal = receiptsTotal - salesTotal;
                
                // Update totals
                totalSales.textContent = formatCurrency(salesTotal);
                totalReceipts.textContent = formatCurrency(receiptsTotal);
                balance.textContent = formatCurrency(balanceTotal);
                
                // Update balance color based on value
                if (balanceTotal > 0) {
                    balance.classList.add('text-green-600');
                    balance.classList.remove('text-red-600', 'text-gray-800');
                } else if (balanceTotal < 0) {
                    balance.classList.add('text-red-600');
                    balance.classList.remove('text-green-600', 'text-gray-800');
                } else {
                    balance.classList.add('text-gray-800');
                    balance.classList.remove('text-green-600', 'text-red-600');
                }
                
                // Display transactions
                if (transactions.length === 0) {
                    transactionsList.innerHTML = `
                        <div class="p-4 text-center text-gray-500">
                            Nenhuma transação registrada
                        </div>
                    `;
                    return;
                }
                
                // Sort transactions by date (newest first)
                transactions.sort((a, b) => new Date(b.date) - new Date(a.date));
                
                transactionsList.innerHTML = '';
                transactions.forEach(t => {
                    const transactionElement = document.createElement('div');
                    transactionElement.className = 'p-4 hover:bg-gray-50 transition';
                    
                    const isSale = t.type === 'sale';
                    const amountClass = isSale ? 'text-red-600' : 'text-green-600';
                    const icon = isSale ? 'shopping-cart' : 'money-bill-wave';
                    
                    transactionElement.innerHTML = `
                        <div class="flex justify-between items-start">
                            <div class="flex items-start space-x-3">
                                <div class="mt-1">
                                    <div class="w-8 h-8 rounded-full flex items-center justify-center ${isSale ? 'bg-red-100 text-red-600' : 'bg-green-100 text-green-600'}">
                                        <i class="fas fa-${icon}"></i>
                                    </div>
                                </div>
                                <div>
                                    <h4 class="font-medium text-gray-800">${t.description}</h4>
                                    <p class="text-sm text-gray-500">${formatDate(t.date)}</p>
                                </div>
                            </div>
                            <div class="text-right">
                                <p class="font-medium ${amountClass}">${isSale ? '-' : '+'} ${formatCurrency(t.amount)}</p>
                                <div class="flex space-x-2 mt-1 justify-end">
                                    <button class="edit-transaction text-indigo-600 hover:text-indigo-800 text-sm" data-id="${t.id}">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="delete-transaction text-red-600 hover:text-red-800 text-sm" data-id="${t.id}">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    transactionsList.appendChild(transactionElement);
                });
                
                // Add event listeners to transaction buttons
                document.querySelectorAll('.edit-transaction').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const transactionId = e.currentTarget.getAttribute('data-id');
                        editTransaction(transactionId);
                    });
                });
                
                document.querySelectorAll('.delete-transaction').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const transactionId = e.currentTarget.getAttribute('data-id');
                        openConfirmationModal('transaction', transactionId);
                    });
                });
            };
            
            request.onerror = (event) => {
                console.error("Error loading transactions:", event.target.error);
            };
        }
        
        function openCustomerModal(action, customer = null) {
            if (action === 'add') {
                modalTitle.textContent = 'Adicionar Cliente';
                customerForm.reset();
                customerId.value = '';
            } else if (action === 'edit' && customer) {
                modalTitle.textContent = 'Editar Cliente';
                customerId.value = customer.id;
                nameInput.value = customer.name;
                emailInput.value = customer.email || '';
                phoneInput.value = customer.phone || '';
                addressInput.value = customer.address || '';
            }
            
            customerModal.classList.remove('hidden');
        }
        
        function openTransactionModal(type, transaction = null) {
            if (!currentCustomer) return;
            
            transactionForm.reset();
            transactionId.value = '';
            transactionCustomerId.value = currentCustomer.id;
            transactionType.value = type;
            
            // Set today's date as default
            const today = new Date().toISOString().split('T')[0];
            transactionDate.value = today;
            
            if (type === 'sale') {
                transactionModalTitle.textContent = transaction ? 'Editar Venda' : 'Nova Venda';
            } else {
                transactionModalTitle.textContent = transaction ? 'Editar Recebimento' : 'Novo Recebimento';
            }
            
            if (transaction) {
                transactionId.value = transaction.id;
                transactionDate.value = transaction.date;
                transactionDescription.value = transaction.description;
                transactionAmount.value = transaction.amount;
            }
            
            transactionModal.classList.remove('hidden');
        }
        
        function openConfirmationModal(type, id = null) {
            if (type === 'customer') {
                if (!currentCustomer) return;
                
                confirmationTitle.textContent = 'Confirmar Exclusão';
                confirmationMessage.textContent = `Tem certeza que deseja excluir o cliente "${currentCustomer.name}"? Todas as transações associadas também serão removidas.`;
                confirmActionBtn.setAttribute('data-type', 'customer');
                confirmActionBtn.setAttribute('data-id', currentCustomer.id);
            } else if (type === 'transaction') {
                confirmationTitle.textContent = 'Confirmar Exclusão';
                confirmationMessage.textContent = 'Tem certeza que deseja excluir esta transação? Esta ação não pode ser desfeita.';
                confirmActionBtn.setAttribute('data-type', 'transaction');
                confirmActionBtn.setAttribute('data-id', id);
            }
            
            confirmationModal.classList.remove('hidden');
        }
        
        function saveCustomer(e) {
            e.preventDefault();
            
            const customer = {
                name: nameInput.value.trim(),
                email: emailInput.value.trim(),
                phone: phoneInput.value.trim(),
                address: addressInput.value.trim()
            };
            
            if (customerId.value) {
                customer.id = customerId.value;
            } else {
                customer.id = uuid.v4();
            }
            
            const transaction = db.transaction('customers', 'readwrite');
            const store = transaction.objectStore('customers');
            
            const request = store.put(customer);
            
            request.onsuccess = () => {
                customerModal.classList.add('hidden');
                loadCustomers();
                
                // If adding a new customer, select it
                if (!customerId.value) {
                    const getRequest = store.getAll();
                    getRequest.onsuccess = (event) => {
                        const customers = event.target.result;
                        const newCustomer = customers.find(c => 
                            c.name === customer.name && 
                            (!customer.email || c.email === customer.email)
                        );
                        
                        if (newCustomer) {
                            selectCustomer(newCustomer);
                        }
                    };
                }
            };
            
            request.onerror = (event) => {
                console.error("Error saving customer:", event.target.error);
            };
        }
        
        function saveTransaction(e) {
            e.preventDefault();
            
            const transactionData = {
                customerId: parseInt(transactionCustomerId.value),
                type: transactionType.value,
                date: transactionDate.value,
                description: transactionDescription.value.trim(),
                amount: parseFloat(transactionAmount.value)
            };
            
            if (transactionId.value) {
                transactionData.id = transactionId.value;
            } else {
                transactionData.id = uuid.v4();
            }
            
            const transaction = db.transaction('transactions', 'readwrite');
            const store = transaction.objectStore('transactions');
            
            const request = store.put(transactionData);
            
            request.onsuccess = () => {
                transactionModal.classList.add('hidden');
                loadTransactions(currentCustomer.id);
            };
            
            request.onerror = (event) => {
                console.error("Error saving transaction:", event.target.error);
            };
        }
        
        function editTransaction(id) {
            const transaction = db.transaction('transactions', 'readonly');
            const store = transaction.objectStore('transactions');
            const request = store.get(id);
            
            request.onsuccess = (event) => {
                const trans = event.target.result;
                if (trans) {
                    openTransactionModal(trans.type, trans);
                }
            };
            
            request.onerror = (event) => {
                console.error("Error getting transaction:", event.target.error);
            };
        }
        
        function confirmAction() {
            const type = confirmActionBtn.getAttribute('data-type');
            const id = confirmActionBtn.getAttribute('data-id');
            
            if (type === 'customer') {
                deleteCustomer(id);
            } else if (type === 'transaction') {
                deleteTransaction(id);
            }
            
            confirmationModal.classList.add('hidden');
        }
        
        function deleteCustomer(id) {
            // First delete all transactions for this customer
            const transaction = db.transaction(['transactions', 'customers'], 'readwrite');
            const transactionsStore = transaction.objectStore('transactions');
            const customersStore = transaction.objectStore('customers');
            
            // Delete transactions
            const index = transactionsStore.index('customerId');
            const request = index.getAll(parseInt(id));
            
            request.onsuccess = (event) => {
                const transactions = event.target.result;
                transactions.forEach(t => {
                    transactionsStore.delete(t.id);
                });
                
                // Then delete the customer
                const deleteRequest = customersStore.delete(id);
                
                deleteRequest.onsuccess = () => {
                    loadCustomers();
                    customerDetailsCard.classList.add('hidden');
                    emptyState.classList.remove('hidden');
                    currentCustomer = null;
                };
                
                deleteRequest.onerror = (event) => {
                    console.error("Error deleting customer:", event.target.error);
                };
            };
            
            request.onerror = (event) => {
                console.error("Error getting transactions:", event.target.error);
            };
        }
        
        function deleteTransaction(id) {
            const transaction = db.transaction('transactions', 'readwrite');
            const store = transaction.objectStore('transactions');
            const request = store.delete(id);
            
            request.onsuccess = () => {
                loadTransactions(currentCustomer.id);
            };
            
            request.onerror = (event) => {
                console.error("Error deleting transaction:", event.target.error);
            };
        }
        
        // Phone mask function
        function applyPhoneMask(input) {
            let value = input.value.replace(/\D/g, '');
            let formattedValue = '';
            
            if (value.length > 0) {
                formattedValue = '(' + value.substring(0, 2);
            }
            if (value.length > 2) {
                formattedValue += ') ' + value.substring(2, 7);
            }
            if (value.length > 7) {
                formattedValue += '-' + value.substring(7, 11);
            }
            
            input.value = formattedValue;
        }

        // Import/Export functions
        function exportData() {
            const transaction = db.transaction(['customers', 'transactions'], 'readonly');
            const customersStore = transaction.objectStore('customers');
            const transactionsStore = transaction.objectStore('transactions');
            
            Promise.all([
                new Promise((resolve) => {
                    const request = customersStore.getAll();
                    request.onsuccess = (e) => resolve(e.target.result);
                }),
                new Promise((resolve) => {
                    const request = transactionsStore.getAll();
                    request.onsuccess = (e) => resolve(e.target.result);
                })
            ]).then(([customers, transactions]) => {
                const data = {
                    customers: customers,
                    transactions: transactions,
                    exportedAt: new Date().toISOString()
                };
                
                const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `clientes-backup-${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                URL.revokeObjectURL(url);
            });
        }

        function importData(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    if (!data.customers || !data.transactions) {
                        alert('Arquivo inválido: formato de dados incorreto');
                        return;
                    }
                    
                    if (!confirm(`Deseja importar ${data.customers.length} clientes e ${data.transactions.length} transações?`)) {
                        return;
                    }
                    
                    const transaction = db.transaction(['customers', 'transactions'], 'readwrite');
                    const customersStore = transaction.objectStore('customers');
                    const transactionsStore = transaction.objectStore('transactions');
                    
                    // Clear existing data
                    customersStore.clear();
                    transactionsStore.clear();
                    
                    // Import customers
                    data.customers.forEach(customer => {
                        customersStore.add(customer);
                    });
                    
                    // Import transactions
                    data.transactions.forEach(transaction => {
                        transactionsStore.add(transaction);
                    });
                    
                    transaction.oncomplete = () => {
                        alert('Importação concluída com sucesso!');
                        loadCustomers();
                        customerDetailsCard.classList.add('hidden');
                        emptyState.classList.remove('hidden');
                    };
                    
                    transaction.onerror = () => {
                        alert('Erro durante a importação');
                    };
                    
                } catch (error) {
                    alert('Erro ao processar arquivo: ' + error.message);
                }
            };
            reader.readAsText(file);
        }

        // Helper functions
        function formatCurrency(value) {
            return new Intl.NumberFormat('pt-BR', {
                style: 'currency',
                currency: 'BRL'
            }).format(value);
        }
        
        function formatDate(dateString) {
            const options = { day: '2-digit', month: '2-digit', year: 'numeric' };
            return new Date(dateString).toLocaleDateString('pt-BR', options);
        }
        
        // Add phone mask event listener
        phoneInput.addEventListener('input', () => {
            applyPhoneMask(phoneInput);
        });

        // Initialize with empty state
        customerDetailsCard.classList.add('hidden');
        emptyState.classList.remove('hidden');
    </script>
</body>
</html>
