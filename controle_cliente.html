<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controle de Clientes</title>
    <link rel="icon" href="https://cdn-icons-png.flaticon.com/512/10384/10384161.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/feather-icons"></script>
    <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
    <style>
        .payment-btn {
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        #chartContainers {
            scrollbar-width: thin;
            scrollbar-color: #1e40af #f0f9ff;
        }
        #chartContainers::-webkit-scrollbar {
            height: 8px;
        }
        #chartContainers::-webkit-scrollbar-thumb {
            background: #1e40af;
            border-radius: 4px;
        }
    </style>
</head>
<body class="bg-[#183462] min-h-screen text-white" style="font-family: 'Segoe UI', system-ui, sans-serif;">
    <!-- Header -->
    <header class="py-6 px-4 lg:px-8 bg-[#0f2a50] shadow-lg" data-aos="fade-down">
        <div class="container mx-auto flex flex-col md:flex-row justify-between items-center gap-4">
            <div class="flex items-center">
                <i data-feather="users" class="mr-3 w-8 h-8 text-cyan-300"></i>
                <h1 class="text-2xl md:text-3xl font-bold bg-gradient-to-r from-cyan-400 to-blue-400 bg-clip-text text-transparent">Controle de Clientes</h1>
            </div>
            <div class="flex flex-wrap gap-3">
                <button id="exportCsv" class="flex items-center gap-2 bg-emerald-600 hover:bg-emerald-700 px-4 py-2 rounded-lg text-sm font-medium transition">
                    <i data-feather="download" class="w-4 h-4"></i> Exportar CSV
                </button>
                <button id="importCsv" class="flex items-center gap-2 bg-amber-600 hover:bg-amber-700 px-4 py-2 rounded-lg text-sm font-medium transition">
                    <i data-feather="upload" class="w-4 h-4"></i> Importar CSV
                </button>
                <input type="file" id="csvFile" class="hidden" accept=".csv">
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-4 pt-8 pb-16 flex flex-col lg:flex-row gap-8">
        <!-- Left Column - Form & Summary -->
        <div class="lg:w-1/3 space-y-8">
            <!-- Form Section -->
            <section class="bg-[#1e3f70] rounded-xl p-6 shadow-xl" data-aos="fade-right">
                <h2 class="text-xl font-bold mb-6 border-b border-blue-400 pb-2">Cadastrar Cliente</h2>
                <form id="clientForm" class="space-y-4">
                    <div>
                        <label for="name" class="block text-sm font-medium mb-1">Nome Completo</label>
                        <input type="text" id="name" required class="w-full px-4 py-2 bg-[#2a4e8a] text-white rounded-lg border border-blue-600 focus:border-cyan-400 focus:ring-1 focus:ring-cyan-400 outline-none transition">
                    </div>
                    
                    <div>
                        <label for="phone" class="block text-sm font-medium mb-1">Telefone</label>
                        <input type="tel" id="phone" required class="w-full px-4 py-2 bg-[#2a4e8a] text-white rounded-lg border border-blue-600 focus:border-cyan-400 focus:ring-1 focus:ring-cyan-400 outline-none transition" placeholder="(__) _____-____">
                    </div>
                    
                    <div>
                        <label for="day" class="block text-sm font-medium mb-1">Dia de Pagamento</label>
                        <select id="day" required class="w-full px-4 py-2 bg-[#2a4e8a] text-white rounded-lg border border-blue-600 focus:border-cyan-400 focus:ring-1 focus:ring-cyan-400 outline-none transition">
                            <option value="">Selecione o dia</option>
                            <script>
                                for (let i = 1; i <= 30; i++) {
                                    document.write(`<option value="${i}">${i}</option>`);
                                }
                            </script>
                        </select>
                    </div>
                    
                    <div>
                        <label for="fee" class="block text-sm font-medium mb-1">Mensalidade (R$)</label>
                        <input type="number" id="fee" min="1" step="0.01" required class="w-full px-4 py-2 bg-[#2a4e8a] text-white rounded-lg border border-blue-600 focus:border-cyan-400 focus:ring-1 focus:ring-cyan-400 outline-none transition" placeholder="0,00">
                    </div>
                    
                    <button type="submit" class="w-full bg-gradient-to-r from-blue-500 to-cyan-500 hover:from-blue-600 hover:to-cyan-600 py-2 rounded-lg font-medium mt-4 transition-all duration-300 transform hover:scale-[1.02]">Salvar Cliente</button>
                </form>
            </section>

            <!-- Summary Section -->
            <section class="bg-[#1e3f70] rounded-xl p-6 shadow-xl" data-aos="fade-right" data-aos-delay="100">
                <h2 class="text-xl font-bold mb-6 border-b border-blue-400 pb-2">Resumo Financeiro</h2>
                <div class="space-y-4">
                    <div class="flex justify-between py-2 border-b border-sky-800">
                        <span>Total Estimado:</span>
                        <span id="totalEstimated" class="font-bold">R$ 0,00</span>
                    </div>
                    <div class="flex justify-between py-2 border-b border-sky-800">
                        <span>Total Recebido:</span>
                        <span id="totalPaid" class="font-bold text-emerald-400">R$ 0,00</span>
                    </div>
                    <div class="flex justify-between py-2 border-b border-sky-800">
                        <span>Total Pendente:</span>
                        <span id="totalPending" class="font-bold text-amber-400">R$ 0,00</span>
                    </div>
                    <div class="flex justify-between pt-2">
                        <span>Pagamentos Pendentes:</span>
                        <span id="pendingPayments" class="font-bold text-amber-400">0</span>
                    </div>
                </div>
            </section>
        </div>

        <!-- Right Column - Client List & Charts -->
        <div class="lg:w-2/3 space-y-8">
            <!-- Client List -->
            <section class="bg-[#1e3f70] rounded-xl p-6 shadow-xl" data-aos="fade-left">
                <h2 class="text-xl font-bold mb-6 border-b border-blue-400 pb-2 flex items-center gap-2">
                    <i data-feather="list"></i> Lista de Clientes
                </h2>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4" id="clientList">
                    <!-- Clients will be dynamically inserted here -->
                    <div class="flex items-center justify-center py-10">
                        <p class="text-center text-gray-400 animate-pulse flex flex-col items-center">
                            <i data-feather="user-plus" class="w-8 h-8 mb-2"></i>
                            Cadastre seu primeiro cliente
                        </p>
                    </div>
                </div>
            </section>

            <!-- Charts -->
            <section class="bg-[#1e3f70] rounded-xl p-6 shadow-xl" data-aos="fade-left" data-aos-delay="100">
                <h2 class="text-xl font-bold mb-6 border-b border-blue-400 pb-2 flex items-center gap-2">
                    <i data-feather="pie-chart"></i> Análise Financeira
                </h2>
                
                <div id="chartContainers" class="flex overflow-x-auto gap-6 pb-4">
                    <div class="flex-none w-full md:w-96 h-80">
                        <canvas id="paymentChart"></canvas>
                    </div>
                    <div class="flex-none w-full md:w-96 h-80">
                        <canvas id="clientDistributionChart"></canvas>
                    </div>
                </div>
            </section>
        </div>
    </main>

    <!-- Client Template (Hidden) -->
    <template id="clientTemplate">
        <div class="bg-[#2a4e8a] rounded-lg p-4 transition-all duration-300 hover:shadow-lg hover:border-blue-500 border border-blue-700/50 flex flex-col">
            <div class="flex justify-between items-start">
                <div>
                    <h3 class="font-bold text-white" data-field="name">Cliente</h3>
                    <div class="flex items-center mt-1">
                        <i data-feather="phone" class="w-3 h-3 mr-2 text-blue-300"></i>
                        <a href="#" data-field="phone" class="text-sm text-blue-200 hover:underline" onclick="redirectToWhatsApp(this)"></a>
                    </div>
                </div>
                <div class="text-right">
                    <span data-field="fee" class="text-xl font-bold text-amber-300"></span>
                    <div class="text-sm">Dia: <span data-field="day" class="text-emerald-300 font-medium"></span></div>
                </div>
            </div>
            
            <div class="mt-4 flex justify-between items-center pt-3 border-t border-sky-700">
                <span id="paymentStatus" class="text-sm">
                    Status: <span class="font-medium text-amber-400">Pendente</span>
                </span>
                <div class="flex gap-2 items-center">
                    <button class="payment-btn text-xs bg-emerald-600 hover:bg-emerald-700 px-3 py-1 rounded transition disabled:bg-gray-700 disabled:cursor-not-allowed"
                            data-action="pay">
                            
                            <i data-feather="pie-chart"></i>
                        Liquida
                    </button>
                    <button class="payment-btn text-xs bg-blue-600 hover:bg-blue-700 px-3 py-1 rounded transition flex items-center gap-1" data-action="edit">
                        Alt
                    </button>
                    <button class="payment-btn text-xs bg-rose-600 hover:bg-rose-700 px-3 py-1 rounded transition flex items-center gap-1" data-action="delete">
                        <!-- <i data-feather="trash" class="w-4 h-4"></i> -->
                        Del
                    </button>
                </div>
            </div>
        </div>
    </template>

    <!-- Scripts -->
    <script>
        // Initialize libraries
        document.addEventListener('DOMContentLoaded', function() {
            feather.replace();
            AOS.init({duration: 800});
            
            // Replace icons again after client list is rendered
            document.getElementById('clientForm').addEventListener('submit', function() {
                setTimeout(feather.replace, 300);
            });
        });

        // Phone number mask
        document.getElementById('phone').addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            
            if (value.length > 11) value = value.substring(0, 11);
            if (value.length > 10) {
                value = value.replace(/(\d{2})(\d{5})(\d{4})/, '($1) $2-$3');
            } else if (value.length > 6) {
                value = value.replace(/(\d{2})(\d{4})(\d{0,4})/, '($1) $2-$3');
            } else if (value.length > 2) {
                value = value.replace(/(\d{2})(\d{0,5})/, '($1) $2');
            }
            
            e.target.value = value;
        });

        // Initialize Charts
        let paymentChart = new Chart(
            document.getElementById('paymentChart'),
            {
                type: 'pie',
                data: {
                    labels: ['Recebido', 'Pendente'],
                    datasets: [{
                        label: 'Pagamentos',
                        data: [0, 0],
                        backgroundColor: [
                            'rgba(52, 211, 153, 0.8)',
                            'rgba(251, 191, 36, 0.8)'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { position: 'top', labels: { color: '#e2e8f0' } },
                        tooltip: { mode: 'index', intersect: false }
                    }
                }
            }
        );

        let clientDistributionChart = new Chart(
            document.getElementById('clientDistributionChart'),
            {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        label: '% do Total',
                        data: [],
                        backgroundColor: 'rgba(56, 189, 248, 0.8)',
                        borderRadius: 5
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: false },
                        tooltip: { mode: 'index', intersect: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            ticks: { color: '#e2e8f0' },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        },
                        x: {
                            ticks: { color: '#e2e8f0' },
                            grid: { display: false }
                        }
                    }
                }
            }
        );

        // Database Operations
        const dbName = "clientControlDB";
        const clientStore = "clients";
        
        function openDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(dbName, 1);
                
                request.onupgradeneeded = function(event) {
                    const db = event.target.result;
                    if (!db.objectStoreNames.contains(clientStore)) {
                        const store = db.createObjectStore(clientStore, { keyPath: "id" });
                        store.createIndex("byDay", "day", { unique: false });
                    }
                };
                
                request.onsuccess = function() {
                    resolve(request.result);
                };
                
                request.onerror = function() {
                    reject("Error opening database");
                };
            });
        }
        
        // Client Data Structure
        class Client {
            constructor(id, name, phone, day, fee, payments = {}) {
                this.id = id;
                this.name = name;
                this.phone = phone;
                this.day = parseInt(day);
                this.fee = parseFloat(fee);
                this.payments = payments; // { year-month: true/false }
            }
        }

        // Main App Logic
        let db;
        let clients = [];

        async function initApp() {
            try {
                db = await openDB();
                await loadClients();
                renderClientList();
                updateSummary();
                updateCharts();
            } catch (err) {
                console.error("Database error:", err);
            }
            
            // Setup form submission
            document.getElementById('clientForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                await saveClient();
            });
            
            // Setup CSV buttons
            document.getElementById('exportCsv').addEventListener('click', exportCSV);
            document.getElementById('importCsv').addEventListener('click', function() {
                document.getElementById('csvFile').click();
            });
            
            document.getElementById('csvFile').addEventListener('change', importCSV);
        }

        async function loadClients() {
            const transaction = db.transaction([clientStore], "readonly");
            const store = transaction.objectStore(clientStore);
            const allRecords = store.getAll();
            
            return new Promise((resolve) => {
                allRecords.onsuccess = function() {
                    clients = allRecords.result.map(record => new Client(
                        record.id,
                        record.name,
                        record.phone,
                        record.day,
                        record.fee,
                        record.payments || {}
                    )).sort((a, b) => a.day - b.day);
                    resolve();
                };
            });
        }

        function renderClientList() {
            const container = document.getElementById('clientList');
            container.innerHTML = '';
            
            if (clients.length === 0) {
                container.innerHTML = `
                    <div class="col-span-2 flex items-center justify-center py-10">
                        <p class="text-center text-gray-400 flex flex-col items-center">
                            <i data-feather="user-plus" class="w-8 h-8 mb-2"></i>
                            Nenhum cliente cadastrado
                        </p>
                    </div>
                `;
                feather.replace();
                return;
            }
            
            clients.sort((a, b) => a.day - b.day).forEach(client => {
                const template = document.getElementById('clientTemplate').content.cloneNode(true);
                template.querySelector('[data-field="name"]').textContent = client.name;
                template.querySelector('[data-field="phone"]').textContent = client.phone;
                template.querySelector('[data-field="day"]').textContent = client.day;
                template.querySelector('[data-field="fee"]').textContent = `R$ ${client.fee.toFixed(2)}`;
                
                // Check if current month is paid
                const now = new Date();
                const yearMonth = `${now.getFullYear()}-${now.getMonth() + 1}`;
                const isPaid = client.payments[yearMonth] || false;
                
                const status = template.querySelector('#paymentStatus span');
                const payBtn = template.querySelector('[data-action="pay"]');
                
                if (isPaid) {
                    status.textContent = "Recebido";
                    status.className = "font-medium text-emerald-400";
                    payBtn.textContent = "Desfazer";
                    payBtn.classList.remove('bg-emerald-600', 'hover:bg-emerald-700');
                    payBtn.classList.add('bg-amber-600', 'hover:bg-amber-700');
                    payBtn.dataset.action = "unpay";
                } else {
                    status.textContent = "Pendente";
                    status.className = "font-medium text-amber-400";
                }
                
                // Add event listeners
                payBtn.addEventListener('click', async () => {
                    await togglePaymentStatus(client.id);
                });
                
                template.querySelector('[data-action="edit"]').addEventListener('click', () => {
                    editClient(client.id);
                });
                
                template.querySelector('[data-action="delete"]').addEventListener('click', () => {
                    if(confirm(`Tem certeza que deseja excluir o cliente ${client.name}?`)) {
                        deleteClient(client.id);
                    }
                });
                
                container.appendChild(template);
            });
        }

        async function saveClient() {
            const nameEl = document.getElementById('name');
            const phoneEl = document.getElementById('phone');
            const dayEl = document.getElementById('day');
            const feeEl = document.getElementById('fee');
            
            const name = nameEl.value.trim();
            const phone = phoneEl.value.trim();
            const day = dayEl.value;
            const fee = feeEl.value;
            
            if(!name || !phone || !day || !fee) {
                alert('Preencha todos os campos!');
                return;
            }
            
            const id = self.crypto.randomUUID();
            const client = new Client(id, name, phone, day, fee);
            
            const transaction = db.transaction([clientStore], "readwrite");
            const store = transaction.objectStore(clientStore);
            store.add(client);
            
            await new Promise(resolve => transaction.oncomplete = resolve);
            
            // Reset form
            nameEl.value = '';
            phoneEl.value = '';
            dayEl.value = '';
            feeEl.value = '';
            
            await loadClients();
            renderClientList();
            updateSummary();
            updateCharts();
        }

        async function deleteClient(id) {
            const transaction = db.transaction([clientStore], "readwrite");
            const store = transaction.objectStore(clientStore);
            store.delete(id);
            
            await new Promise(resolve => transaction.oncomplete = resolve);
            await loadClients();
            renderClientList();
            updateSummary();
            updateCharts();
        }

        function editClient(id) {
            const client = clients.find(c => c.id === id);
            if(!client) return;
            
            document.getElementById('name').value = client.name;
            document.getElementById('phone').value = client.phone;
            document.getElementById('day').value = client.day;
            document.getElementById('fee').value = client.fee;
            
            // Simulate edit mode by scrolling to form
            document.querySelector('form').scrollIntoView({behavior: 'smooth'});
        }

        async function togglePaymentStatus(clientId) {
            const clientIndex = clients.findIndex(c => c.id === clientId);
            if(clientIndex === -1) return;
            
            const now = new Date();
            const yearMonth = `${now.getFullYear()}-${now.getMonth() + 1}`;
            
            // Toggle payment status
            clients[clientIndex].payments[yearMonth] = !clients[clientIndex].payments[yearMonth];
            
            // Update database
            const transaction = db.transaction([clientStore], "readwrite");
            const store = transaction.objectStore(clientStore);
            store.put(clients[clientIndex]);
            
            await new Promise(resolve => transaction.oncomplete = resolve);
            await loadClients();
            renderClientList();
            updateSummary();
            updateCharts();
        }

        function updateSummary() {
            const totalEstimated = clients.reduce((sum, client) => sum + client.fee, 0);
            const now = new Date();
            const yearMonth = `${now.getFullYear()}-${now.getMonth() + 1}`;
            
            const paidClients = clients.reduce((sum, client) => {
                return client.payments[yearMonth] ? sum + client.fee : sum;
            }, 0);
            
            const pendingClients = clients.filter(client => !client.payments[yearMonth]);
            const pendingPayments = pendingClients.length;
            
            document.getElementById('totalEstimated').textContent = `R$ ${totalEstimated.toFixed(2)}`;
            document.getElementById('totalPaid').textContent = `R$ ${paidClients.toFixed(2)}`;
            document.getElementById('totalPending').textContent = `R$ ${(totalEstimated - paidClients).toFixed(2)}`;
            document.getElementById('pendingPayments').textContent = pendingPayments;
        }

        function updateCharts() {
            // Update payment chart
            const now = new Date();
            const yearMonth = `${now.getFullYear()}-${now.getMonth() + 1}`;
            const paidClients = clients.filter(client => client.payments[yearMonth]);
            const pendingClients = clients.filter(client => !client.payments[yearMonth]);
            
            const paidAmount = paidClients.reduce((sum, client) => sum + client.fee, 0);
            const pendingAmount = pendingClients.reduce((sum, client) => sum + client.fee, 0);
            
            paymentChart.data.datasets[0].data = [paidAmount, pendingAmount];
            paymentChart.update();
            
            // Update client distribution
            const totalFees = clients.reduce((sum, client) => sum + client.fee, 0);
            const clientPercentages = clients.map(client => {
                return totalFees > 0 ? (client.fee / totalFees * 100).toFixed(1) : 0;
            });
            
            clientDistributionChart.data.labels = clients.map(c => c.name.substring(0, 12) + (c.name.length > 12 ? "..." : ""));
            clientDistributionChart.data.datasets[0].data = clientPercentages;
            clientDistributionChart.update();
        }

        function exportCSV() {
            if(clients.length === 0) {
                alert("Não há clientes para exportar!");
                return;
            }
            
            let csv = "id,name,phone,day,fee\n";
            clients.forEach(client => {
                csv += `"${client.id}","${client.name}","${client.phone}",${client.day},${client.fee}\n`;
            });
            
            const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
            const url = URL.createObjectURL(blob);
            const link = document.createElement("a");
            link.setAttribute("href", url);
            link.setAttribute("download", "clientes.csv");
            link.style.visibility = "hidden";
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function importCSV(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const contents = e.target.result;
                const lines = contents.split("\n").slice(1); // Skip header
                
                if (lines.length === 0 || lines[0].trim() === "") {
                    alert("O arquivo CSV está vazio ou mal formatado!");
                    return;
                }
                
                // Process lines
                const importClient = [];
                
                lines.forEach(line => {
                    if (!line.trim()) return;
                    const [id, name, phone, day, fee] = line.split(",")
                        .map(item => item.replace(/^"(.*)"$/, "$1"));
                    
                    if (!id || !name || !phone || !day || !fee) return;
                    
                    importClient.push(new Client(
                        id.trim(),
                        name.trim(),
                        phone.trim(),
                        parseInt(day.trim()),
                        parseFloat(fee.trim())
                    ));
                });
                
                if (importClient.length === 0) {
                    alert("Nenhum cliente válido encontrado no CSV!");
                    return;
                }
                
                // Start import transaction
                importClients(importClient);
            };
            
            reader.onerror = function() {
                alert("Erro ao ler o arquivo CSV!");
            };
            
            reader.readAsText(file);
            // Reset input to allow importing same file again
            event.target.value = "";
        }

        async function importClients(importClients) {
            const transaction = db.transaction([clientStore], "readwrite");
            const store = transaction.objectStore(clientStore);
            
            // Import clients with conflict resolution (update by id)
            importClients.forEach(client => {
                const request = store.get(client.id);
                
                request.onsuccess = function() {
                    const existingClient = request.result;
                    if (existingClient) {
                        // Update existing client info but keep payments
                        const payments = existingClient.payments || {};
                        store.put(new Client(
                            client.id,
                            client.name,
                            client.phone,
                            client.day,
                            client.fee,
                            payments
                        ));
                    } else {
                        // Add new client
                        store.add(client);
                    }
                };
            });
            
            await new Promise(resolve => transaction.oncomplete = resolve);
            await loadClients();
            renderClientList();
            updateSummary();
            updateCharts();
            alert(`CSV importado com sucesso (${importClients.length} clientes processados)`);
        }

        // WhatsApp redirect function
        function redirectToWhatsApp(element) {
            const phone = element.textContent.replace(/\D/g, '');
            if (phone) {
                window.open(`https://api.whatsapp.com/send?phone=55${phone}`, '_blank');
            }
        }

        // Initialize application when DOM is loaded
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
